// –ö–æ–Ω—Ñ–∏–≥
const SB_URL='https://jttsgizkuyipolcnvanc.supabase.co',SB_KEY='sb_publishable_MV93VmhU8U2I-2m8UquKkw_Eril4zvp',supabase=window.supabase.createClient(SB_URL,SB_KEY);
let state={user:null,balance:0,inventory:[]},cases=[],skins=[],selectedCase=null,selectedCaseId=null,currentCaseSkins=[];

async function init(){console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');await checkAuth();await loadData();if(state.user)await loadPlayer();setupModalListeners();updateUI();}
function setupModalListeners(){document.querySelectorAll('.modal').forEach(e=>{e.addEventListener('click',function(t){t.target===this&&(this.style.display='none')})});}

// –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
async function checkAuth(){try{const{data:e}=await supabase.auth.getSession();if(e.session){state.user=e.session.user,document.getElementById('auth-btn').style.display='none',document.getElementById('logout-btn').style.display='block',document.getElementById('user-email').textContent=state.user.email;const{data:t}=await supabase.from('users').select('role').eq('id',state.user.id).single();t?.role==='admin'&&(document.getElementById('admin-btn').style.display='block')}else document.getElementById('auth-btn').style.display='block',document.getElementById('logout-btn').style.display='none',document.getElementById('admin-btn').style.display='none',document.getElementById('user-email').textContent='–ì–æ—Å—Ç—å'}catch(t){console.error('–û—à–∏–±–∫–∞ auth:',t)}}async function logout(){await supabase.auth.signOut(),location.reload()}

// –î–∞–Ω–Ω—ã–µ
async function loadData(){try{const[{data:e},{data:t}]=await Promise.all([supabase.from('cases').select('*'),supabase.from('skins').select('*')]);cases=e||[],skins=t||[],renderCases()}catch(a){console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:',a)}}async function loadPlayer(){if(!state.user)return;const{data:e}=await supabase.from('users').select('balance').eq('id',state.user.id).single();e&&(state.balance=e.balance);const{data:t}=await supabase.from('player_inventory').select('skin_id').eq('player_id',state.user.id);state.inventory=t||[],updateUI(),renderInventory()}

// UI
function updateUI(){document.getElementById('balance').textContent=state.balance,document.getElementById('inventory').textContent=state.inventory.length}function renderCases(){const e=document.getElementById('cases');e&&(e.innerHTML=cases.length?cases.map(e=>`<div class="case" onclick="previewCase(${e.id})"><h3>${e.emoji||'üì¶'} ${e.name}</h3><p>${e.price} –º–æ–Ω–µ—Ç</p></div>`).join(''):'<p>–ö–µ–π—Å—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>')}function renderInventory(){const e=document.getElementById('inventory-list');e&&(e.innerHTML=state.inventory.length?state.inventory.map(e=>{const t=skins.find(t=>t.id===e.skin_id);return`<div class="skin">${t?.name||'–°–∫–∏–Ω'} #${e.skin_id}</div>`}).join(''):'<p>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</p>')}

// –ö–µ–π—Å—ã
function previewCase(e){selectedCase=cases.find(t=>t.id===e);if(!state.user)return alert('–í–æ–π–¥–∏—Ç–µ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–æ–≤'),showLogin();document.getElementById('preview-title').textContent=selectedCase.name,document.getElementById('preview-price').textContent=`–¶–µ–Ω–∞: ${selectedCase.price} –º–æ–Ω–µ—Ç`,document.getElementById('preview-modal').style.display='block'}async function openCase(){if(!selectedCase||!state.user)return alert('–û—à–∏–±–∫–∞');if(state.balance<selectedCase.price)return alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'),closeModal('preview-modal');try{const e=await fetch('https://mute-night-5909.zummer-max405.workers.dev/api/open-case',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({player_id:state.user.id,case_id:selectedCase.id,case_price:selectedCase.price})}),t=await e.json();t.success?(state.balance=t.newBalance,updateUI(),alert('–í—ã–∏–≥—Ä–∞–ª–∏: '+(t.skin||'—Å–∫–∏–Ω')),closeModal('preview-modal'),await loadPlayer()):alert('–û—à–∏–±–∫–∞: '+(t.error||'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'))}catch(a){alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è')}}

// –ê–¥–º–∏–Ω–∫–∞
async function adminPanel(){if(!state.user)return;document.getElementById('admin-modal').style.display='block';const{data:e}=await supabase.from('users').select('role').eq('id',state.user.id).single();if(e?.role!=='admin')return document.getElementById('admin-content').innerHTML='<p>–ù–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>';await loadAdminData()}async function loadAdminData(){await Promise.all([loadAdminCases(),loadAdminSkins()])}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
async function loadAdminCases(){try{const{data:e}=await supabase.from('cases').select('*').order('id'),t=document.getElementById('admin-cases-list');t&&(t.innerHTML=e.map(e=>`<div class="admin-case-item ${selectedCaseId===e.id?'selected':''}" onclick="selectAdminCase(${e.id})"><div style="font-size:24px">${e.emoji||'üì¶'}</div><div>${e.name}</div><div style="font-size:.8em">${e.price} –º–æ–Ω–µ—Ç</div></div>`).join(''))}catch(t){console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–µ–π—Å–æ–≤:',t)}}async function selectAdminCase(e){selectedCaseId=e;const{data:t}=await supabase.from('cases').select('*').eq('id',e).single();if(t){document.getElementById('selected-case-info').innerHTML=`<h4>${t.emoji||'üì¶'} ${t.name}</h4><p>–¶–µ–Ω–∞: ${t.price} –º–æ–Ω–µ—Ç</p>`;await loadCaseSkins(e)}}

async function loadAdminSkins(){try{const{data:e}=await supabase.from('skins').select('*').order('id'),t=document.getElementById('admin-skins-list');t&&(t.innerHTML=e.map(e=>`<div class="admin-skin-item" draggable="true" ondragstart="dragStart(event,${e.id})" ondragend="dragEnd(event)" data-id="${e.id}" title="${e.name} - ${e.price} –º–æ–Ω–µ—Ç (${getRarityName(e.rarity)})">${e.emoji||'üéÆ'}<div style="font-size:.7em">${e.name}</div></div>`).join(''))}catch(t){console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–∏–Ω–æ–≤:',t)}}

// Drag & Drop
function allowDrop(e){e.preventDefault(),e.currentTarget.classList.add('drag-over')}function dragLeave(e){e.currentTarget.classList.remove('drag-over')}function dragStart(e,t){e.dataTransfer.setData('skinId',t),e.currentTarget.classList.add('dragging')}function dragEnd(e){e.currentTarget.classList.remove('dragging')}
function dropOnCase(e){e.preventDefault(),e.currentTarget.classList.remove('drag-over');const t=e.dataTransfer.getData('skinId');if(!t||!selectedCaseId)return;const a=parseInt(t),s=parseInt(prompt('–£–∫–∞–∂–∏—Ç–µ —à–∞–Ω—Å –≤—ã–ø–∞–¥–µ–Ω–∏—è (1-100):','10'))||10;if(s<1||s>100)return alert('–®–∞–Ω—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 100');addSkinToCase(a,s)}

// –†–∞–±–æ—Ç–∞ —Å –∫–µ–π—Å–∞–º–∏
async function loadCaseSkins(e){try{const{data:t}=await supabase.from('case_skins').select(`skin_id,weight,skins(name,emoji)`).eq('case_id',e),a=document.getElementById('case-skins-list');currentCaseSkins=t||[],a&&(a.innerHTML=t.length?t.map(t=>`<div class="case-skin-item"><span>${t.skins?.emoji||'üéÆ'} ${t.skins?.name||'–°–∫–∏–Ω'}</span><input type="number" value="${t.weight||10}" min="1" max="100" onchange="updateSkinWeight(${t.skin_id},this.value)" style="width:60px;margin:0 5px;"><button onclick="removeSkinFromCase(${t.skin_id})">√ó</button></div>`).join(''):'<p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ —Å–∫–∏–Ω—ã</p>')}catch(s){console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–∏–Ω–æ–≤:',s)}}
function addSkinToCase(e,t){if(currentCaseSkins.find(a=>a.skin_id===e))return alert('–≠—Ç–æ—Ç —Å–∫–∏–Ω —É–∂–µ –≤ –∫–µ–π—Å–µ');currentCaseSkins.push({skin_id:e,weight:t}),updateCaseSkinsDisplay()}function updateSkinWeight(e,t){const a=currentCaseSkins.findIndex(a=>a.skin_id===e);a>-1&&(currentCaseSkins[a].weight=parseInt(t)||10)}function removeSkinFromCase(e){currentCaseSkins=currentCaseSkins.filter(t=>t.skin_id!==e),updateCaseSkinsDisplay()}function updateCaseSkinsDisplay(){const e=document.getElementById('case-skins-list');e&&(e.innerHTML=currentCaseSkins.length?currentCaseSkins.map(e=>`<div class="case-skin-item"><span>–°–∫–∏–Ω #${e.skin_id}</span><input type="number" value="${e.weight||10}" min="1" max="100" onchange="updateSkinWeight(${e.skin_id},this.value)" style="width:60px;margin:0 5px;"><button onclick="removeSkinFromCase(${e.skin_id})">√ó</button></div>`).join(''):'<p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ —Å–∫–∏–Ω—ã</p>')}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–µ–π—Å–∞
async function saveCaseSkins(){if(!selectedCaseId||!currentCaseSkins.length)return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–µ–π—Å –∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–∫–∏–Ω—ã');try{await supabase.from('case_skins').delete().eq('case_id',selectedCaseId);const e=currentCaseSkins.map(e=>({case_id:selectedCaseId,skin_id:e.skin_id,weight:e.weight||10}));await supabase.from('case_skins').insert(e),alert(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ! ${e.length} —Å–∫–∏–Ω–æ–≤ –≤ –∫–µ–π—Å–µ`),await loadCaseSkins(selectedCaseId)}catch(e){console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:',e),alert('–û—à–∏–±–∫–∞: '+e.message)}}

// –°–æ–∑–¥–∞–Ω–∏–µ –∫–µ–π—Å–∞/—Å–∫–∏–Ω–∞
async function createNewCase(){const e=document.getElementById('new-case-name').value.trim(),t=parseInt(document.getElementById('new-case-price').value);if(!e||!t||t<=0)return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É');try{await supabase.from('cases').insert([{name:e,price:t,emoji:'üì¶'}]),alert('–ö–µ–π—Å —Å–æ–∑–¥–∞–Ω'),document.getElementById('new-case-name').value='',document.getElementById('new-case-price').value='',await loadAdminCases(),await loadData()}catch(a){alert('–û—à–∏–±–∫–∞: '+a.message)}}async function createNewSkin(){const e=document.getElementById('new-skin-name').value.trim(),t=parseInt(document.getElementById('new-skin-price').value);if(!e||!t||t<=0)return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É');try{await supabase.from('skins').insert([{name:e,price:t,rarity:'common',emoji:'üéÆ'}]),alert('–°–∫–∏–Ω —Å–æ–∑–¥–∞–Ω'),document.getElementById('new-skin-name').value='',document.getElementById('new-skin-price').value='100',await loadAdminSkins()}catch(a){alert('–û—à–∏–±–∫–∞: '+a.message)}}

// –£—Ç–∏–ª–∏—Ç—ã
function getRarityName(e){return{common:'–û–±—ã—á–Ω—ã–π',rare:'–†–µ–¥–∫–∏–π',epic:'–≠–ø–∏—á–µ—Å–∫–∏–π',legendary:'–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π'}[e]||'–û–±—ã—á–Ω—ã–π'}function showAuth(){document.getElementById('login-modal').style.display='block'}function showLogin(){document.getElementById('login-modal').style.display='block'}function showRegister(){document.getElementById('register-modal').style.display='block',document.getElementById('login-modal').style.display='none'}function closeModal(e){document.getElementById(e).style.display='none'}

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–≤—Ö–æ–¥
async function handleRegister(){const e=document.getElementById('register-email').value.trim(),t=document.getElementById('register-password').value.trim();if(!e||!t||t.length<6)return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)');try{const{error:a}=await supabase.auth.signUp({email:e,password:t});a?alert('–û—à–∏–±–∫–∞: '+a.message):(alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!'),closeModal('register-modal'),showLogin())}catch(s){alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏')}}async function handleLogin(){const e=document.getElementById('login-email').value.trim(),t=document.getElementById('login-password').value.trim();if(!e||!t)return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');try{const{error:a}=await supabase.auth.signInWithPassword({email:e,password:t});a?alert('–û—à–∏–±–∫–∞: '+a.message):(closeModal('login-modal'),location.reload())}catch(s){alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞')}}

// –ó–∞–ø—É—Å–∫
document.addEventListener('DOMContentLoaded',init);